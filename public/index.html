<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sports Article Graph Analyzer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }

    @media (max-width: 1024px) {
      .content {
        grid-template-columns: 1fr;
      }
    }

    .section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 30px;
      background: #f9f9f9;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .section h3 {
      color: #555;
      margin-top: 25px;
      margin-bottom: 15px;
      font-size: 1.1em;
    }

    /* Upload Form */
    .upload-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    input[type="file"],
    input[type="text"],
    select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    input[type="file"]:focus,
    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* Articles List */
    .articles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .article-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 4px solid #667eea;
    }

    .article-card:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      border-left-color: #764ba2;
    }

    .article-card h4 {
      color: #333;
      margin-bottom: 10px;
      word-break: break-word;
    }

    .article-card-meta {
      font-size: 0.85em;
      color: #666;
      margin: 10px 0;
    }

    .article-card-meta strong {
      color: #333;
    }

    .article-id {
      font-family: monospace;
      font-size: 0.8em;
      color: #999;
      word-break: break-all;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    .badge {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      margin: 5px 5px 5px 0;
    }

    .metadata-section {
      background: #f8f9fa;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .metadata-row {
      display: flex;
      align-items: center;
      margin: 6px 0;
      gap: 8px;
    }

    .metadata-label {
      font-weight: 600;
      color: #555;
      min-width: 80px;
    }

    .metadata-value {
      color: #333;
    }

    .flag-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.8em;
      font-weight: 600;
      margin-left: 5px;
    }

    .flag-badge.true {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .flag-badge.false {
      background: #f5f5f5;
      color: #666;
    }

    /* Metadata Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .modal-header h2 {
      margin: 0;
      color: #333;
      word-break: break-word;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #333;
    }

    .metadata-json {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      line-height: 1.5;
      overflow-x: auto;
      color: #333;
    }

    .metadata-json-key {
      color: #667eea;
      font-weight: 600;
    }

    .metadata-json-string {
      color: #28a745;
    }

    .metadata-json-number {
      color: #ff6b6b;
    }

    .metadata-json-boolean {
      color: #ffc107;
    }

    /* Query Section */
    .query-section {
      margin-top: 20px;
    }

    .query-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .query-inputs input,
    .query-inputs select {
      grid-column: span 1;
    }

    @media (max-width: 500px) {
      .query-inputs {
        grid-template-columns: 1fr;
      }
    }

    .query-result {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 20px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .query-result pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85em;
      line-height: 1.4;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
    }

    .stat-card .value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-card .label {
      color: #666;
      font-size: 0.95em;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .path-display {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
    }

    .path-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }

    .path-item-title {
      flex: 1;
      font-weight: 500;
      color: #333;
    }

    .path-item-distance {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      margin: 0 10px;
    }

    .path-arrow {
      color: #667eea;
      font-weight: bold;
      margin: 0 10px;
    }

    .error-message {
      color: #d32f2f;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state p {
      font-size: 1.1em;
      margin: 10px 0;
    }

    /* Club styles */
    .club-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 20px;
      margin: 10px 0;
      border-left: 4px solid #764ba2;
      transition: all 0.3s;
    }

    .club-card:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      border-left-color: #667eea;
    }

    .club-card h4 {
      color: #333;
      margin-bottom: 10px;
    }

    .club-meta {
      font-size: 0.9em;
      color: #666;
      margin: 5px 0;
    }

    .club-socials {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .social-link {
      display: inline-block;
      background: #e8f4f8;
      color: #0066cc;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      text-decoration: none;
    }

    .club-articles-count {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      font-size: 0.85em;
      color: #667eea;
      font-weight: 600;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 1em;
      resize: vertical;
      min-height: 80px;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #666;
      font-size: 0.9em;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .club-detail {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
    }

    .club-detail h4 {
      color: #667eea;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèÜ Sports Article Graph Analyzer</h1>
      <p>Analyze articles, build relationships, and discover relevance through graph distance</p>
    </div>

    <div class="content">
      <!-- Left Column: Upload and Overview -->
      <div>
        <div class="section">
          <h2>üì§ Upload Article</h2>
          <form id="uploadForm" class="upload-form">
            <input type="file" id="articleFile" accept=".txt" required placeholder="Select article file">
            <input type="text" id="articleTitle" placeholder="Article title (optional)">
            <label style="color: #666; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="generateContent">
              Generate enhanced article with AI
            </label>
            <button type="submit">Analyze Article</button>
          </form>
          <div id="uploadMessage"></div>
        </div>

        <div class="section">
          <h2>üìä Overview</h2>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="value" id="totalArticles">0</div>
              <div class="label">Total Articles</div>
            </div>
            <div class="stat-card">
              <div class="value" id="totalConnections">0</div>
              <div class="label">Connections</div>
            </div>
            <div class="stat-card">
              <div class="value" id="avgConnections">0</div>
              <div class="label">Avg per Article</div>
            </div>
            <div class="stat-card">
              <div class="value" id="counties">0</div>
              <div class="label">Counties</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>üì∞ Articles in System</h2>
          <button onclick="loadArticles()" style="width: 100%; margin-bottom: 15px;">Refresh Articles</button>
          <div id="articlesContainer" class="articles-grid"></div>
        </div>

        <div class="section">
          <h2>üèÖ Add Club Profile</h2>
          <form id="clubForm" class="upload-form">
            <input type="text" id="clubName" placeholder="Club Name *" required>
            <div class="form-row">
              <input type="text" id="clubCounty" placeholder="County *" required>
              <input type="text" id="clubLeague" placeholder="League (optional)">
            </div>
            <textarea id="clubDescription" placeholder="Club description (optional)"></textarea>
            <input type="url" id="clubWebsite" placeholder="Website URL (optional)">
            <input type="text" id="clubTwitter" placeholder="Twitter handle (optional)">
            <input type="text" id="clubFacebook" placeholder="Facebook page (optional)">
            <input type="text" id="clubInstagram" placeholder="Instagram handle (optional)">
            <button type="submit">Create Club Profile</button>
          </form>
          <div id="clubMessage"></div>
        </div>

        <div class="section">
          <h2>üèÜ Clubs in System</h2>
          <button onclick="loadClubs()" style="width: 100%; margin-bottom: 15px;">Refresh Clubs</button>
          <input type="text" id="clubSearchQuery" placeholder="Search clubs by name..." style="width: 100%; margin-bottom: 10px;" onkeyup="filterClubs()">
          <div id="clubsContainer" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>

      <!-- Right Column: Queries and Tools -->
      <div>
        <div class="section">
          <h2>üîç Graph Tools</h2>

          <div class="tabs">
            <button class="tab active" onclick="switchTab('distance')">Distance</button>
            <button class="tab" onclick="switchTab('related')">Related</button>
            <button class="tab" onclick="switchTab('search')">Search</button>
          </div>

          <!-- Distance Tab -->
          <div id="distance" class="tab-content active">
            <h3>Calculate Distance</h3>
            <div class="query-inputs">
              <input type="text" id="distanceFrom" placeholder="From Article ID">
              <input type="text" id="distanceTo" placeholder="To Article ID">
              <label style="grid-column: span 2; color: #666;">
                <input type="checkbox" id="distanceWeighted" checked>
                Use weighted distance
              </label>
            </div>
            <button onclick="calculateDistance()" style="width: 100%;">Calculate Distance</button>
            <div id="distanceResult" class="query-result" style="display: none;"></div>
          </div>

          <!-- Related Tab -->
          <div id="related" class="tab-content">
            <h3>Find Related Articles</h3>
            <input type="text" id="relatedArticleId" placeholder="Article ID" style="width: 100%; margin-bottom: 10px;">
            <div class="query-inputs">
              <input type="number" id="maxDistance" value="2" min="1" max="10" placeholder="Max Distance">
              <input type="number" id="resultLimit" value="10" min="1" max="100" placeholder="Limit results">
            </div>
            <button onclick="findRelated()" style="width: 100%;">Find Related Articles</button>
            <div id="relatedResult" class="query-result" style="display: none;"></div>
          </div>

          <!-- Search Tab -->
          <div id="search" class="tab-content">
            <h3>Search Articles</h3>
            <select id="searchType" style="width: 100%; margin-bottom: 10px;">
              <option value="">Select search type...</option>
              <option value="club">By Club</option>
              <option value="county">By County</option>
              <option value="league">By League</option>
            </select>
            <input type="text" id="searchQuery" placeholder="Enter search term" style="width: 100%; margin-bottom: 10px;">
            <button onclick="searchArticles()" style="width: 100%;">Search</button>
            <div id="searchResult" class="query-result" style="display: none;"></div>
          </div>
        </div>

        <div class="section">
          <h2>üí¨ Ask Questions</h2>
          <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
            Ask natural language questions about your articles using AI-powered semantic search
          </p>
          <textarea 
            id="queryQuestion" 
            placeholder="E.g., Which teams reached the semi-finals? What happened in the championship?"
            style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit; font-size: 1em; margin-bottom: 10px; resize: vertical;"
            onkeydown="if(event.key==='Enter' && (event.ctrlKey || event.metaKey)){event.preventDefault(); askQuestion();}"
          ></textarea>
          <button onclick="askQuestion()" style="width: 100%;">üîç Ask Question</button>
          <p style="color: #999; font-size: 0.8em; margin-top: 8px; text-align: center;">
            Press Ctrl+Enter (Cmd+Enter on Mac) to submit
          </p>
          <div id="queryAnswer" class="query-result" style="display: none;"></div>
        </div>

        <div class="section">
          <h2>‚öôÔ∏è System Stats</h2>
          <button onclick="loadStats()" style="width: 100%; margin-bottom: 15px;">Refresh Stats</button>
          <div id="detailedStats"></div>
        </div>

        <div class="section" id="clubDetailSection" style="display: none;">
          <h2>üìã Club Details</h2>
          <div id="clubDetailContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Detect current port from window location
    const API_BASE = `${window.location.origin}/api`;

    // Load articles on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadArticles();
      loadStats();
      loadClubs();
    });

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('articleFile');
      const titleInput = document.getElementById('articleTitle');
      const messageDiv = document.getElementById('uploadMessage');

      if (!fileInput.files[0]) {
        showMessage(messageDiv, 'Please select a file', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      if (titleInput.value) {
        formData.append('title', titleInput.value);
      }
      
      // Add generateContent flag
      const generateContent = document.getElementById('generateContent').checked;
      formData.append('generateContent', generateContent);

      try {
        const loadingMsg = generateContent 
          ? 'Generating and analyzing article<span class="loading"></span>' 
          : 'Analyzing article<span class="loading"></span>';
        messageDiv.innerHTML = `<div class="message info">${loadingMsg}</div>`;
        
        const response = await fetch(`${API_BASE}/articles/analyze`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          let successMsg = 'Article analyzed successfully!';
          if (data.article.generatedHeadline) {
            successMsg += '<br><small>Generated headline: ' + data.article.generatedHeadline + '</small>';
          }
          showMessage(messageDiv, successMsg, 'success');
          fileInput.value = '';
          titleInput.value = '';
          document.getElementById('generateContent').checked = false;
          setTimeout(() => {
            loadArticles();
            loadStats();
          }, 1000);
        } else {
          showMessage(messageDiv, 'Error: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showMessage(messageDiv, 'Error: ' + error.message, 'error');
      }
    });

    function showMessage(div, message, type) {
      div.innerHTML = `<div class="message ${type}">${message}</div>`;
      if (type === 'success') {
        setTimeout(() => {
          div.innerHTML = '';
        }, 5000);
      }
    }

    async function loadArticles() {
      try {
        const response = await fetch(`${API_BASE}/articles`);
        const data = await response.json();

        const container = document.getElementById('articlesContainer');
        if (data.articles.length === 0) {
          container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p>No articles yet. Upload one to get started!</p></div>';
          return;
        }

        // Also load clubs to check which ones have profiles
        const clubsResponse = await fetch(`${API_BASE}/clubs`);
        const clubsData = await clubsResponse.json();
        const clubProfiles = clubsData.clubs || [];
        const clubProfileNames = new Set(clubProfiles.map(c => c.name.toLowerCase().trim()));

        container.innerHTML = data.articles.map(article => {
          // Mark clubs that have profiles vs those that don't
          const clubBadges = article.metadata.clubs.map(club => {
            const hasProfile = clubProfileNames.has(club.name.toLowerCase().trim());
            const clubProfile = clubProfiles.find(c => c.name.toLowerCase().trim() === club.name.toLowerCase().trim());
            
            if (hasProfile && clubProfile) {
              return `<span class="badge" style="background: #28a745; cursor: pointer;" onclick="viewClubDetails('${clubProfile.id}')" title="Click to view club profile">\u2705 ${club.name}</span>`;
            } else {
              return `<span class="badge" style="background: #ffc107; color: #333; cursor: pointer;" onclick="quickCreateClub('${club.name.replace(/'/g, "\\'")}', '${club.county.replace(/'/g, "\\'")}', '${club.league ? club.league.replace(/'/g, "\\'") : ''}')" title="Click to create club profile">\u2795 ${club.name}</span>`;
            }
          }).join('');

          return `
            <div class="article-card" onclick="selectArticle('${article.id}', '${article.title.replace(/'/g, "\\'")}')">
              <h4>${article.title}</h4>

              <div class="metadata-section">
                <div class="metadata-row">
                  <span class="metadata-label">Sport:</span>
                  <span class="metadata-value"><strong>${article.metadata.sport || 'Unknown'}</strong></span>
                </div>
                <div class="metadata-row">
                  <span class="metadata-label">County:</span>
                  <span class="metadata-value"><strong>${article.metadata.primaryCounty}</strong></span>
                </div>
                <div class="metadata-row">
                  <span class="metadata-label">Clubs:</span>
                  <span class="metadata-value"><strong>${article.metadata.clubs.length}</strong></span>
                </div>
                ${article.metadata.matches && article.metadata.matches.length > 0 ? `
                <div class="metadata-row">
                  <span class="metadata-label">Matches:</span>
                  <span class="metadata-value"><strong>${article.metadata.matches.length}</strong></span>
                </div>
                ` : ''}
                ${article.metadata.leagues && article.metadata.leagues.length > 0 ? `
                <div class="metadata-row">
                  <span class="metadata-label">Leagues:</span>
                  <span class="metadata-value"><strong>${article.metadata.leagues.join(', ')}</strong></span>
                </div>
                ` : ''}
                <div class="metadata-row">
                  <span class="metadata-label">Fan-Based:</span>
                  <span class="flag-badge ${article.metadata.isFanBased}">${article.metadata.isFanBased ? '‚úì Yes' : '‚úó No'}</span>
                </div>
                <div class="metadata-row">
                  <span class="metadata-label">Commercial:</span>
                  <span class="flag-badge ${article.metadata.isCommercialProduct}">${article.metadata.isCommercialProduct ? '‚úì Yes' : '‚úó No'}</span>
                </div>
              </div>

              ${clubBadges}
              <button onclick="event.stopPropagation(); showArticleMetadata('${article.id.replace(/'/g, "\\'")}', '${article.title.replace(/'/g, "\\'")}', '${JSON.stringify(article.metadata).replace(/'/g, "\\'")}'); return false;" style="width: 100%; margin-top: 10px; padding: 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">üìã View Full Metadata</button>
              <div class="article-id">ID: ${article.id.substring(0, 8)}...</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading articles:', error);
      }
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/graph/stats`);
        const data = await response.json();

        document.getElementById('totalArticles').textContent = data.stats.totalArticles;
        document.getElementById('totalConnections').textContent = data.stats.totalConnections;
        document.getElementById('avgConnections').textContent = data.stats.avgConnectionsPerArticle.toFixed(1);
        document.getElementById('counties').textContent = data.stats.counties.length;

        const statsHtml = `
          <h3>Detailed Stats</h3>
          <div class="article-card-meta">
            <strong>Counties:</strong> ${data.stats.counties.join(', ') || 'None'}
          </div>
          <div class="article-card-meta">
            <strong>Leagues:</strong> ${data.stats.leagues.join(', ') || 'None'}
          </div>
          ${data.stats.mostConnectedArticle ? `
            <div class="article-card-meta">
              <strong>Most Connected:</strong> ${data.stats.mostConnectedArticle.title} (${data.stats.mostConnectedArticle.connections} connections)
            </div>
          ` : ''}
        `;
        document.getElementById('detailedStats').innerHTML = statsHtml;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    function selectArticle(id, title) {
      document.getElementById('distanceFrom').value = id;
      document.getElementById('relatedArticleId').value = id;
      switchTab('related');
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    async function calculateDistance() {
      const fromId = document.getElementById('distanceFrom').value;
      const toId = document.getElementById('distanceTo').value;
      const weighted = document.getElementById('distanceWeighted').checked;
      const resultDiv = document.getElementById('distanceResult');

      if (!fromId || !toId) {
        showMessage(resultDiv, 'Please enter both article IDs', 'error');
        return;
      }

      try {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="message info">Calculating distance<span class="loading"></span></div>';

        const response = await fetch(`${API_BASE}/graph/distance?from=${fromId}&to=${toId}&weighted=${weighted}`);
        const data = await response.json();

        if (data.success) {
          const pathHtml = data.path.map((item, idx) => `
            <div class="path-item">
              <div class="path-item-title">${item.title}</div>
              <div class="path-item-distance">${idx === 0 ? 'Start' : 'Step ' + idx}</div>
            </div>
          `).join('<div class="path-arrow">‚Üì</div>');

          resultDiv.innerHTML = `
            <h3>Distance Result</h3>
            <div class="stat-card">
              <div class="value">${data.distance}</div>
              <div class="label">Hops</div>
            </div>
            <div class="stat-card">
              <div class="value">${(data.relevanceScore * 100).toFixed(0)}%</div>
              <div class="label">Relevance Score</div>
            </div>
            <h3 style="margin-top: 20px;">Path</h3>
            <div class="path-display">${pathHtml}</div>
          `;
        } else {
          resultDiv.innerHTML = '<div class="message error">Error: ' + data.error + '</div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
      }
    }

    async function findRelated() {
      const articleId = document.getElementById('relatedArticleId').value;
      const maxDistance = document.getElementById('maxDistance').value;
      const limit = document.getElementById('resultLimit').value;
      const resultDiv = document.getElementById('relatedResult');

      if (!articleId) {
        showMessage(resultDiv, 'Please enter an article ID', 'error');
        return;
      }

      try {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="message info">Finding related articles<span class="loading"></span></div>';

        const response = await fetch(`${API_BASE}/graph/related/${articleId}?maxDistance=${maxDistance}&limit=${limit}`);
        const data = await response.json();

        if (data.success) {
          let html = `<h3>Related to: ${data.sourceArticle.title}</h3>`;

          for (let distance = 1; distance <= maxDistance; distance++) {
            const articles = data.relatedArticles[distance] || [];
            if (articles.length > 0) {
              html += `<h3 style="margin-top: 15px;">Distance ${distance}</h3>`;
              articles.forEach(article => {
                html += `
                  <div class="article-card" style="margin: 10px 0;">
                    <h4>${article.title}</h4>
                    <div class="article-card-meta">
                      Relevance: <strong>${(article.relevanceScore * 100).toFixed(0)}%</strong>
                    </div>
                    <div class="article-card-meta">
                      Relationship: ${article.relationships.map(r => r.type).join(', ') || 'None'}
                    </div>
                  </div>
                `;
              });
            }
          }

          resultDiv.innerHTML = html || '<div class="message info">No related articles found</div>';
        } else {
          resultDiv.innerHTML = '<div class="message error">Error: ' + data.error + '</div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
      }
    }

    async function searchArticles() {
      const type = document.getElementById('searchType').value;
      const query = document.getElementById('searchQuery').value;
      const resultDiv = document.getElementById('searchResult');

      if (!type || !query) {
        showMessage(resultDiv, 'Please select a search type and enter a query', 'error');
        return;
      }

      try {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="message info">Searching<span class="loading"></span></div>';

        const response = await fetch(`${API_BASE}/graph/search?${type}=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.success) {
          if (data.results.length === 0) {
            resultDiv.innerHTML = '<div class="message info">No articles found</div>';
            return;
          }

          let html = `<h3>Found ${data.results.length} article${data.results.length !== 1 ? 's' : ''}</h3>`;
          data.results.forEach(article => {
            html += `
              <div class="article-card" style="margin: 10px 0;">
                <h4>${article.title}</h4>
                <div class="article-card-meta">
                  <strong>${article.metadata.primaryCounty}</strong> county
                </div>
                ${article.metadata.clubs.map(club => `
                  <span class="badge">${club.name}</span>
                `).join('')}
              </div>
            `;
          });

          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
      }
    }

    async function askQuestion() {
      const question = document.getElementById('queryQuestion').value;
      const resultDiv = document.getElementById('queryAnswer');

      if (!question || question.trim().length === 0) {
        showMessage(resultDiv, 'Please enter a question', 'error');
        resultDiv.style.display = 'block';
        return;
      }

      try {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="message info">Thinking<span class="loading"></span></div>';

        const response = await fetch(`${API_BASE}/articles/query`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ query: question, topK: 3 })
        });

        const data = await response.json();

        if (data.success) {
          let html = `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #667eea; margin-bottom: 10px;">üí° Answer</h3>
              <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; line-height: 1.6;">
                ${data.answer.replace(/\n/g, '<br>')}
              </div>
            </div>
          `;

          if (data.sources && data.sources.length > 0) {
            html += `
              <div>
                <h4 style="color: #666; margin-bottom: 10px;">üìö Sources</h4>
                ${data.sources.map(source => `
                  <div style="background: white; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; margin: 8px 0;">
                    <div style="font-weight: 500; color: #333;">${source.title}</div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
                      Relevance: <strong>${(source.similarity * 100).toFixed(1)}%</strong>
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
          }

          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = '<div class="message error">Error: ' + data.error + '</div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
      }
    }

    // Club Management Functions
    let allClubs = [];

    // Club form submission
    document.getElementById('clubForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageDiv = document.getElementById('clubMessage');

      const clubData = {
        name: document.getElementById('clubName').value,
        county: document.getElementById('clubCounty').value,
        league: document.getElementById('clubLeague').value || null,
        description: document.getElementById('clubDescription').value || null,
        website: document.getElementById('clubWebsite').value || null,
        socials: {}
      };

      // Add social media links if provided
      const twitter = document.getElementById('clubTwitter').value;
      const facebook = document.getElementById('clubFacebook').value;
      const instagram = document.getElementById('clubInstagram').value;
      
      if (twitter) clubData.socials.twitter = twitter;
      if (facebook) clubData.socials.facebook = facebook;
      if (instagram) clubData.socials.instagram = instagram;

      try {
        messageDiv.innerHTML = '<div class="message info">Creating club profile<span class="loading"></span></div>';
        
        const response = await fetch(`${API_BASE}/clubs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(clubData)
        });

        const data = await response.json();

        if (data.success) {
          showMessage(messageDiv, 'Club profile created successfully!', 'success');
          document.getElementById('clubForm').reset();
          setTimeout(() => {
            loadClubs();
          }, 1000);
        } else {
          showMessage(messageDiv, 'Error: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showMessage(messageDiv, 'Error: ' + error.message, 'error');
      }
    });

    async function loadClubs() {
      try {
        const response = await fetch(`${API_BASE}/clubs`);
        const data = await response.json();

        allClubs = data.clubs || [];
        displayClubs(allClubs);
      } catch (error) {
        console.error('Error loading clubs:', error);
        document.getElementById('clubsContainer').innerHTML = 
          '<div class="message error">Error loading clubs</div>';
      }
    }

    function displayClubs(clubs) {
      const container = document.getElementById('clubsContainer');
      
      if (clubs.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No clubs yet. Create one to get started!</p></div>';
        return;
      }

      container.innerHTML = clubs.map(club => {
        const articleCount = club.articleReferences ? club.articleReferences.length : 0;
        let socialsHtml = '';
        
        if (club.socials && Object.keys(club.socials).length > 0) {
          socialsHtml = '<div class="club-socials">';
          for (const [platform, handle] of Object.entries(club.socials)) {
            socialsHtml += `<span class="social-link">üì± ${platform}: ${handle}</span>`;
          }
          socialsHtml += '</div>';
        }

        return `
          <div class="club-card" onclick="viewClubDetails('${club.id}')">
            <h4>${club.name}</h4>
            <div class="club-meta">üìç ${club.county}</div>
            ${club.league ? `<div class="club-meta">üèÜ ${club.league}</div>` : ''}
            ${club.website ? `<div class="club-meta">üåê <a href="${club.website}" target="_blank" onclick="event.stopPropagation()">${club.website}</a></div>` : ''}
            ${socialsHtml}
            <div class="club-articles-count">üì∞ ${articleCount} article${articleCount !== 1 ? 's' : ''}</div>
          </div>
        `;
      }).join('');
    }

    function filterClubs() {
      const query = document.getElementById('clubSearchQuery').value.toLowerCase();
      const filtered = allClubs.filter(club => 
        club.name.toLowerCase().includes(query) ||
        club.county.toLowerCase().includes(query) ||
        (club.league && club.league.toLowerCase().includes(query))
      );
      displayClubs(filtered);
    }

    async function viewClubDetails(clubId) {
      const section = document.getElementById('clubDetailSection');
      const container = document.getElementById('clubDetailContainer');
      
      section.style.display = 'block';
      container.innerHTML = '<div class="message info">Loading club details<span class="loading"></span></div>';
      
      // Scroll to the section
      section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      try {
        const response = await fetch(`${API_BASE}/clubs/${clubId}?includeArticles=true`);
        const data = await response.json();

        if (data.success) {
          const club = data.club;
          const articles = data.recentArticles || [];

          let socialsHtml = '';
          if (club.socials && Object.keys(club.socials).length > 0) {
            socialsHtml = '<div style="margin: 10px 0;"><strong>Social Media:</strong><div class="club-socials" style="margin-top: 5px;">';
            for (const [platform, handle] of Object.entries(club.socials)) {
              socialsHtml += `<span class="social-link">${platform}: ${handle}</span>`;
            }
            socialsHtml += '</div></div>';
          }

          let articlesHtml = '';
          if (articles.length > 0) {
            articlesHtml = '<h4 style="margin-top: 20px; margin-bottom: 10px;">üì∞ Recent Articles</h4>';
            articles.forEach(article => {
              const date = new Date(article.analyzedAt).toLocaleDateString();
              articlesHtml += `
                <div class="article-card" style="margin: 10px 0;">
                  <h4>${article.title}</h4>
                  <div class="article-card-meta">Date: ${date}</div>
                  <div class="article-card-meta">${article.metadata.primaryCounty} ‚Ä¢ ${article.metadata.clubs.length} club${article.metadata.clubs.length !== 1 ? 's' : ''}</div>
                  ${article.metadata.clubs.map(c => `<span class="badge">${c.name}</span>`).join('')}
                </div>
              `;
            });
          } else {
            articlesHtml = '<div class="message info" style="margin-top: 15px;">No articles yet</div>';
          }

          container.innerHTML = `
            <div class="club-detail">
              <h3>${club.name}</h3>
              <div style="margin: 10px 0;">
                <strong>County:</strong> ${club.county}
              </div>
              ${club.league ? `<div style="margin: 10px 0;"><strong>League:</strong> ${club.league}</div>` : ''}
              ${club.description ? `<div style="margin: 10px 0;"><strong>Description:</strong> ${club.description}</div>` : ''}
              ${club.website ? `<div style="margin: 10px 0;"><strong>Website:</strong> <a href="${club.website}" target="_blank">${club.website}</a></div>` : ''}
              ${socialsHtml}
              <div style="margin: 10px 0;">
                <strong>Created:</strong> ${new Date(club.createdAt).toLocaleDateString()}
              </div>
            </div>
            ${articlesHtml}
            <button onclick="closeClubDetails()" style="width: 100%; margin-top: 15px;">Close</button>
          `;
        } else {
          container.innerHTML = '<div class="message error">Error loading club details</div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
      }
    }

    function closeClubDetails() {
      document.getElementById('clubDetailSection').style.display = 'none';
    }

    // Quick create club from article mention
    function quickCreateClub(name, county, league) {
      event.stopPropagation(); // Prevent article card click
      
      // Scroll to club form
      document.querySelector('#clubForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Pre-fill form
      document.getElementById('clubName').value = name;
      document.getElementById('clubCounty').value = county;
      if (league) {
        document.getElementById('clubLeague').value = league;
      }
      
      // Highlight the form
      const clubForm = document.querySelector('#clubForm').parentElement;
      clubForm.style.border = '3px solid #667eea';
      clubForm.style.transition = 'border 0.3s';
      setTimeout(() => {
        clubForm.style.border = '';
      }, 2000);
      
      // Show a helpful message
      const messageDiv = document.getElementById('clubMessage');
      messageDiv.innerHTML = '<div class="message info">‚ú® Form pre-filled! Add details and create profile.</div>';
      setTimeout(() => {
        messageDiv.innerHTML = '';
      }, 5000);
    }

    // Show article metadata in modal
    function showArticleMetadata(articleId, articleTitle, metadataJson) {
      try {
        const metadata = JSON.parse(metadataJson);
        const modal = document.getElementById('metadataModal');
        const modalTitle = document.getElementById('metadataModalTitle');
        const modalContent = document.getElementById('metadataContent');

        modalTitle.textContent = articleTitle;
        modalContent.innerHTML = formatMetadataJSON(metadata);

        modal.classList.add('show');
      } catch (error) {
        console.error('Error displaying metadata:', error);
        alert('Error displaying metadata');
      }
    }

    // Format metadata as readable JSON with syntax highlighting
    function formatMetadataJSON(metadata) {
      const json = JSON.stringify(metadata, null, 2);
      let formatted = json
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/("[\w]+"\s*:)/g, '<span class="metadata-json-key">$1</span>')
        .replace(/:\s*"([^"]*)"/g, ': <span class="metadata-json-string">"$1"</span>')
        .replace(/:\s*(\d+)/g, ': <span class="metadata-json-number">$1</span>')
        .replace(/:\s*(true|false)/g, ': <span class="metadata-json-boolean">$1</span>')
        .replace(/\n/g, '<br>');

      return `<pre class="metadata-json">${formatted}</pre>`;
    }

    // Close metadata modal
    function closeMetadataModal() {
      const modal = document.getElementById('metadataModal');
      modal.classList.remove('show');
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('metadataModal');
      window.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeMetadataModal();
        }
      });
    });
  </script>

  <!-- Metadata Modal -->
  <div id="metadataModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="metadataModalTitle">Article Metadata</h2>
        <button class="modal-close" onclick="closeMetadataModal()">‚úï</button>
      </div>
      <div id="metadataContent"></div>
    </div>
  </div>
</body>
</html>
